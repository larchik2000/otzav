<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Sentiment Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100">

<div class="max-w-2xl mx-auto mt-16 p-8 bg-white rounded-2xl shadow-lg">
    <h1 class="text-2xl font-bold text-gray-800 mb-6 text-center">
        Анализатор Тональности
    </h1>

    <div class="space-y-6">
        <div>
            <label class="block text-gray-700 font-semibold mb-2">
                Выберите CSV-файл
            </label>
            <input id="fileInput" type="file" accept=".csv"
                   class="w-full border p-3 rounded-md">
        </div>

        <button onclick="sendFile()"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-semibold">
            Отправить
        </button>
    </div>

    <!-- PROGRESS BAR -->
    <div id="progressBox" class="mt-6 hidden">
        <div class="w-full bg-gray-300 rounded-full h-4">
            <div id="progressBar" class="bg-blue-600 h-4 rounded-full" style="width: 0%"></div>
        </div>
        <p id="progressText" class="text-center mt-2 text-gray-700 text-sm"></p>
    </div>

    <div id="result" class="mt-8 text-gray-700"></div>

    <div class="mt-6">
        <button id="downloadBtn" onclick="downloadCSV()" style="display:none"
                class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-semibold">
            Скачать результат CSV
        </button>
    </div>
</div>

<script>
let resultJson = null;  // ← ВАЖНО: одно имя!

async function sendFile() {
    const file = document.getElementById("fileInput").files[0];
    if (!file) {
        alert("Выберите файл!");
        return;
    }

    document.getElementById("progressBox").classList.remove("hidden");
    document.getElementById("progressBar").style.width = "0%";
    document.getElementById("progressText").innerText = "Начинаем обработку...";

    const formData = new FormData();
    formData.append("file", file);

    const response = await fetch("/predict-stream", {
        method: "POST",
        body: formData
    });

    const reader = response.body.getReader();
    const decoder = new TextDecoder();

    while (true) {
        const {value, done} = await reader.read();
        if (done) break;

        const chunk = decoder.decode(value, {stream: true});

        chunk.split("\n\n").forEach(block => {
            if (!block.startsWith("data:")) return;

            const data = JSON.parse(block.replace("data: ", ""));

            // ошибка
            if (data.error) {
                document.getElementById("result").innerText = data.error;
                return;
            }

            // прогресс
            if (data.progress !== undefined) {
                document.getElementById("progressBar").style.width = data.progress + "%";
                document.getElementById("progressText").innerText =
                    `Обработано ${data.current} из ${data.total}`;
            }

            // финал
            if (data.done) {
                resultJson = data.result;   // ← важно!
            }
        });
    }

    // проверка результата
    if (!resultJson) {
        document.getElementById("result").innerText = "Ошибка обработки файла";
        return;
    }

    // превью
    // превью 10 строк
    const preview = resultJson.slice(0, 10);
    let html = `
        <h2 class="text-xl font-semibold mb-4">Первые 10 результатов:</h2>
        <table class="w-full border">
            <thead>
                <tr class="bg-gray-200">
                    <th class="border px-2 py-1">ID</th>
                    <th class="border px-2 py-1">Текст</th>
                    <th class="border px-2 py-1">Label</th>
                </tr>
            </thead>
            <tbody>
    `;

    preview.forEach(row => {
        html += `
            <tr>
                <td class="border px-2 py-1">${row.id}</td>
                <td class="border px-2 py-1">${row.text}</td>
                <td class="border px-2 py-1">${row.label}</td>
            </tr>`;
    });

    html += `
            </tbody>
        </table>
        <p class="mt-4">Всего строк обработано: ${resultJson.length}</p>
    `;


    document.getElementById("result").innerHTML = html;
    document.getElementById("downloadBtn").style.display = "block";
}


function downloadCSV() {
    if (!resultJson) return;

    const rows = ["ID,label"];

    resultJson.forEach(obj => {
        rows.push(`${obj.id},${obj.label}`);
    });

    const csv = rows.join("\n");
    const blob = new Blob([csv], {type: "text/csv"});
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "submission.csv";
    a.click();

    URL.revokeObjectURL(url);
}
</script>


</body>
</html>